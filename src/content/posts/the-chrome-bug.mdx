---
title: "הבאג שהתחבא 4 שנים: איך מצאתי באג בכרומיום שמקריס את הטאב."
date: "2025-11-10"
author: "Elad Heller"
tags: ["debugging", "chrome", "iframe", "bug-hunting"]
description: "כשנתקלים בבאג, אפשר להתעצבן ואפשר לדבג. או: ככה שחזרתי באג שהתחבא בכרום יותר מ-4 שנים."
---

## להתרגז או לדבג

הכל התחיל כשגלשתי באתר של חילן (מערכת ניהול משאבי אנוש), וניסיתי לעדכן את ימי המילואים שלי. על המסך קפצה הודעה על המסמכים הדרושים. אני, כמו מתכנת טוב, משתמש במקלדת - לוחץ Enter כדי לסגור את ההודעה.

ופתאום...

```text
💥 Aw, Snap!
Something went wrong while displaying this webpage.
```

די מרגיז, אבל ניסיתי שוב.

אבל אז זה קורה שוב. ושוב. **כל פעם שאני לוחץ Enter על ההודעה - הטאב קורס.**

כשמתכנת נתקל בבאג, הוא יכול להתעצבן או לדבג. החלטתי לדבג:

- לחיצה עם העכבר? ✅ עובד מצוין.
- לחיצה עם <span dir="ltr">Enter</span>? 💥 CRASH.
- לחיצה עם <span dir="ltr">Space</span>? 💥 CRASH.

משהו בקוד של הדף גורם לכרום לקרוס כשמשתמשים במקלדת. אבל מה?

ניסיתי לדבג את הקוד, וראיתי שההודעה נמצאת בתוך IFrame, והטאב קורס כשמסירים את ה-Iframe.

כדי לראות אם צדקתי, החלטתי לנסות לחזר.
## נסיונות שחזור

החלטתי לנסות לשחזר עם Cursor:
```text
I think there is a bug in chrome when script inside IFrame remove the iframe from dom.
Can you create a minimal reproduce?
For example: Iframe with a button, when you clicked on the button, script in the iframe run and remove the IFrame.
The Iframe can be in the same domain.
```
ה-cursor יצר גרסה פשוטה. הרצתי אותה, אבל הבאג לא השתחזר.

ניסינו כל מיני וריאציות:
- ליצור את ה-iframe דינמית.
- לשים את הכפתור בתוך from.
- לשים חלקים שונים בקוד בתוך ה-iframe ומחוץ ל-iframe.
- ועוד...

**שום דבר לא עבד.**

הייתי בטוח שאפשר לשחזר את הבאג, אבל קשה מאוד להבין מה הקומבינציה שגרמה לבאג. הקוד הוא די גדול ויכולים להיות הרבה חלקים שגורמים לבאג.

## פריצת הדרך

בסוף החלטתי לתת ל-cursor את כל הקוד של ה-iframe.

סוף סוף הוא יצר דוגמה שמשחזרת את הבאג, עברתי עליה והורדתי עוד כמה דברים מיותרים, עד שהגענו לדוגמה **המינימלית** שמשחזרת את הבאג:

### הדף הראשי (`index.html`)

```html
<!DOCTYPE html>
<html>
<head>
    <title>Chrome IFrame Bug</title>
</head>
<body>
    <h1>Parent Page</h1>
    <iframe id="iframe" src="iframe.html" width="400" height="300"></iframe>
    <script>
        const iframe = document.getElementById('iframe');
        
        function hide() {
            iframe.remove();
        }
    </script>
</body>
</html>
```

### תוכן ה-iframe (`iframe.html`)

```html
<!DOCTYPE html>
<html>
<head>
    <title>IFrame Content</title>
</head>
<body>
    <h2>IFrame Content</h2>
    <button id="btn">OK</button>
    <script>
        const btn = document.getElementById('btn');

        // זה המפתח! שימוש ב-onkeypress ולא ב-addEventListener
        btn.onkeypress = function (e) {
            if (e.keyCode == 13 || e.charCode == 32) {
                window.parent.hide(); // קריאה לפונקציה בחלון האב
                return e.preventDefault(); // הפונקציה הזו מנסה לרוץ כשה-iframe כבר לא קיים ומקריסה את הטאב
            }
        };
    </script>
</body>
</html>
```

זהו. **11 שורות קוד <span dir="ltr">javascript</span>** והטאב קורס. 💥

## מה בדיוק קורה?

הבאג קורה בגלל שרשרת אירועים מאוד ספציפית:

1. **משתמש לוחץ Enter** על הכפתור בתוך ה-iframe.
2. **`btn.onkeypress` handler** (בתוך ה-iframe) מופעל.
3. ה-handler קורא ל-**`window.parent.hide()`** - פונקציה בדף האב.
4. הפונקציה בדף האב קוראת ל-**`iframe.remove()`** - מוחקת את ה-iframe.
5. **ה-iframe נמחק** בזמן שה-event handler עדיין פועל.
6. הפונקציה <span dir="ltr">`event.preventDefault()`</span> מנסה לעצור את התנהגות ברירת המחדל של הכפתור.
7. **ה-iframe כבר לא קיים** 💥 CRASH!

בעצם, כרום מנסה לחזור ל-execution context שכבר לא קיים, וזה גורם לקריסה מלאה של הטאב.

## איך באג כזה נשאר 4 שנים בכרום?

הבאג הזה קיים בכרומיום **מאז גרסה 91** (שיצאה במאי 2021), אבל כמעט אף אחד לא נתקל בו. למה?

כי צריך **כל התנאים האלה ביחד**:

### 1. רק ב-macOS
הבאג מתרחש **רק במק**. בלינוקס ו-Windows הכל עובד תקין.

### 2. 🔗 iframe באותו domain
צריך iframe שיכול לגשת ישירות לחלון האב:
- `same-origin` - iframe באותו domain כמו הדף
- בקוד מודרני כמעט ולא משתמשים ב-iframe. ואם משתמשים בו, מתקשרים איתו באמצעות משתמשים ב-`postMessage` ולא בגישה ישירה

```javascript
// זה גורם לבאג ⚠️
window.parent.hide();

// זה לא ✅
window.parent.postMessage({ action: 'hide' }, '*');
```

### 3. קוד legacy
צריך להשתמש בדרך הישנה והלא מומלצת:

```javascript
// הדרך הישנה שגורמת לבאג ⚠️
btn.onkeypress = function(e) { ... }

// הדרך המודרנית שלא גורמת לבאג ✅
btn.addEventListener('keypress', function(e) { ... })
```

נדיר מאוד למצוא קוד מודרני שעובד בצורה כזו, ולכן הבאג הזה חי בשקט כבר 4 שנים.

## הדיווח ל-Chromium
כדי לוודא שהבאג לא קורה רק אצלי, השתמשתי ב-[Browsers Stack](https://live.browserstack.com/dashboard) כדי לבדוק גרסאות כרום בסביבות שונות.

מסתבר שהבאג התחיל בגרסה 91 ומשתחזר רק במחשבי Mac, אבל גם בגרסת Chrome Canary הוא עדיין קיים.

יצרתי [דוגמה חיה](https://eladheller.github.io/reproduce-iframe-bug/) שמשחזרת את הבאג ב-100% מהמקרים.

[דיווחתי ל-Chromium](https://issues.chromium.org/issues/459123383) ומישהו שם כבר שחזר את הבאג.
מן הסתם יקחו כמה חודשים עד שייכנס תיקון ועד שהתיקון יגיע למשתמשים.
## ומה למדתי?

1. **AI יכול לעזור** - Cursor עזר לי לתמצת את הבעיה מתוך מאות שורות קוד.
2. כשנתקלים בבאג, אפשר להתעצבן ואפשר לתקן.
3. אם באמת רוצים להשפיע, כדאי ליצור minimal reproduction שיעשה כמה שיותר מהעבודה, ככה יש יותר סיכוי שיטפלו בבאג.

## נסו בעצמכם

הקוד המלא זמין ב-[GitHub](https://github.com/eladheller/reproduce-iframe-bug).

אם אתם עובדים על Mac עם Chrome, אתם מוזמנים לנסות את [הדוגמה החיה](https://eladheller.github.io/reproduce-iframe-bug/).
